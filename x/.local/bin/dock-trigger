#!/bin/sh

set -e -b -u -f

undocked_script="$HOME/.config/dock-trigger/undocked.sh"
docked_script="$HOME/.config/dock-trigger/docked.sh"

pid_file="/tmp/dock-trigger_$USER.pid"
running=1
alias msgf='printf 1>&2'

write_pid_file() {
    if [ -f "$pid_file" ]; then
        msgf 'Dock Trigger is running? Found pid file: %s.\n' "$pid_file"
        exit 1
    fi

    printf >"$pid_file" '%s' "$$"
    msgf 'Wrote pid file: %s.\n' "$pid_file"
}

stop() {
    msgf 'Received exit signal, goodbye.\n'
    rm "$pid_file"
    msgf 'Deleted pid file: %s.\n' "$pid_file"
    running=0
}

execute() {
    status="$1"
    script="$2"

    msgf 'Status: %s.\n' "$status"

    if [ -x "$script" ]
    then
        "$script"
    elif [ -f "$script" ]
    then
        msgf "Warning: %s is missing an execute bit. You may need to run chmod +x %s.\n" "$script" "$script"
    else
        msgf "Warning: %s doesn't exist.\n" "$script"
    fi
}

trigger() {
    msgf 'Received trigger signal.\n'
    case "$(sysctl -n dev.acpi_dock.0.status)" in
        0) execute "Undocked" "$undocked_script";;
        1) execute "Docked" "$docked_script";;
        *) msgf 'Warning: Unknown value (ignored): %s.\n' "$1";;
    esac
}

trap stop SIGHUP
trap stop SIGINT
trap stop SIGQUIT
trap stop SIGTERM
trap trigger SIGUSR1

write_pid_file

while [ $running -eq 1 ]; do
done
